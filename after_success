#!/bin/sh
set -e

# Directories.
root_dir=`pwd`
build_dir="/tmp/_travis/build"
install_dir="/tmp/_travis/install"

if [ -d debian ]; then
    if `test x${DIST} = x`; then
	echo "distribution is not set, skipping this build"
	exit 0
    fi
    echo "Target distribution: ${DIST}"

    export GNUPGHOME="$root_dir/.travis/.gnupg"
    # If the build is a success, upload the source package to Launchpad.
    if `test x${DIST} = xunstable`; then
	echo "Debian Sid package. Skipping Launchpad upload..."
    else
	dput ppa:${PPA_URI} "$build_dir"/export/*_source.changes
    fi
else
    if [ ! x${DIST} = x ]; then
	echo "skipping this build"
	exit 0
    fi

    # Only retrieve data from the test suite run.
    coveralls -r $build_dir/tests
    # Set the push capable URL.
    git remote set-url origin "${GH_PUSH_URI}"
    # Retrieve last commit of the gh-pages branch.
    git fetch --depth=1 origin gh-pages:gh-pages
    # Update the documentation.
    cd $build_dir/doc && ../../../cmake/github/update-doxygen-doc.sh

    # Push git note indicating success
    cd $root_dir
    notes_msg="Successful build.\n----\n\nDependencies commit id:"
    for package in ${GIT_DEPENDENCIES}; do
	cd $build_dir/$package
	notes_msg="${notes_msg} $package : " $(git rev-parse HEAD) "\n"
    done
    cd $root_dir
    git fetch --depth=1 origin refs/notes/travis:refs/notes/travis
    git notes --ref=travis add -m "$(echo -e "${notes_msg}")" HEAD
    git push origin refs/notes/travis
fi
